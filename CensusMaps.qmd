---
title: "TidyCensus"
format: pdf
editor: source
---

```{r}
library(tidycensus)
library(tidyverse)
```

```{r}
# census_api_key("47ee8dc952e1d11f1fdea8be7a02b71241c29d42", install = TRUE)
# Sys.getenv("CENSUS_API_KEY")
year5 = 2023 #most recent 5-year data available
year1 = 2024 #most recent 1-year data available
caption_5year = paste0("Source: ", year5-4, "-", year5," ACS 5-year estimates")
caption_1year = paste0("Source: ", year1, " ACS 1-year estimates")
#when I'm making this 2024 1-year has been released but not 2024 5-year
```

```{r}
clean_data <- function(data){
  variables = unique(data$variable)
  data <- data |>
    rename(fips = GEOID)
  
  if("total" %in% variables) {
    total = data %>% filter(variable == "total") %>% 
      select(fips, total = estimate) #renaming and selecting in one line
    data = left_join(data, total, by = "fips") |>
      mutate(portion = estimate / total)
  }
  return(data)
}

filter_data = function(data, map_variables){
  filtered_data = data |>
    filter(variable %in% map_variables) |>
    group_by(fips, total) |>
    summarize(estimate = sum(estimate)) |>
    mutate(portion = estimate / total)
  return(filtered_data)
}

census_api_call <- function(vars, year = year5, survey = "acs5", geographies = c("state", "puma", "county", "us")) {
  #can use survey = acs1 for 1-year data but most demographic data doesn't change very quickly so 5-year estimates should be fine
  
  data_list <- list()
  totals_list <- list()
  
  for (geo in geographies) {
    
    df <- get_acs(
      geography = geo,
      variables = vars,
      year = year,
      survey = survey
    ) |>
      clean_data()
    
    data_list[[geo]] <- df
  }
  data <- bind_rows(data_list)
  return(data)
}
```

```{r}
#ChatGPT map ideas - need to double-check each table is what is says because it messes up sometimes

# Demographics & Population
# Total Population – B01003_001
# Median Age – B01002_001
# Population Under 18 Years – B09001_001 or B01001 series (sum of relevant ages)
# Population 65+ Years – sum of B01001_X for ages 65+ (or use B01001_020 etc.)
# Sex Ratio / Male Population – B01001_002
# Female Population – B01001_026 (or relevant female lines in B01001)

# Race & Ethnicity
# White alone, not Hispanic or Latino – from race / ethnicity tables (e.g., B02001/B03002)
# Black or African American alone – B02001_003
# Hispanic or Latino (of any race) – B03003_003

# Nativity & Citizenship
# Foreign-born population – e.g. B05003_001 minus native born
# Non-citizen population – B05007_005

# Education
# Total population 25+ – B15003_001
# High school graduate (includes equivalency) – B15003_017
# Bachelor’s degree – B15003_022
# Graduate or professional degree – B15003_023, B15003_024, B15003_025

# Income & Poverty
# Median Household Income – B19013_001
# Mean Household Income – (various tables e.g., B19025 etc.)
# Poverty status: number of people below poverty – B17001_002
# Poverty Rate (poverty ÷ total population) – use B17001_002 / B17001_001

# Housing & Living Conditions
# Number of housing units – B25001_001
# Occupied housing units – B25002_002
# Owner-occupied housing units – B25003_002
# Renter-occupied units – B25003_003
# Median value of owner-occupied housing units – B25077_001
# Median gross rent – B25064_001
# Average household size – B25010_001 divided by number of occupied housing units

# Commute / Transport
# Mean travel time to work – B08303_001
# Vehicle availability: households with no vehicle – B08201_002 (or relevant “vehicles available = 0” line)
# Means of transportation to work – from B08301 or B08135 (walk, car, public transit etc.)

# Technology Access
# Households with no computer – part of B28002 series
# Households with no internet subscription – also B28002_X or B28004 groupings
# Broadband subscription / high speed internet – if detailed enough

# Health & Insurance
# Health insurance coverage – B27001_001 (total), B27001_X for uninsured etc.
# Public health insurance – B27003_X
# Private health insurance – B27002_X

# Employment & Labor
# Labor force participation (population 16+) – from B23025
# Unemployment number – from B23025 or similar
# Employment by industry – from B24010
# Employment by occupation – from B24010 / B23022 etc. (occupation tables)
# Mean earnings – B20002 or B20004 (by sex etc.)

# Disability & Ageing
# Population with disability – B18101_001 (or relevant lines)
# Seniors living alone – combinations from B11007 etc.

# Language & Nativity
# Speak a language other than English at home – B16001_X / B16002 etc.
# Speak English “less than very well” – B16004_X etc.

# Household composition
# Single parent households – B11005_001 etc.
# Number of households / families – B11001_001
# Average number of people per household – B25010_001 / B25002_002

# Housing Age & Quality
# Year structure built (e.g. pre-1940 structures) – B25034 lines
# Housing units lacking plumbing – B25049_X

# Poverty among children – B17001 series, child age bands
# Veteran population – B21001 series

# Migration / Mobility
# Movers in past year – B07001 (geographical mobility)
# Place of birth – B05002 etc.

# Divisors / Totals you will need
# Total population – B01003_001
# Total households – B11001_001
# Total housing units – B25001_001
# Total population 25+ (for education rates) – B15003_001
# Total labor force/population 16+ – from relevant labor force tables (B23025 etc.)
# Total population under poverty / above poverty – B17001_001
```

#Educational Attainment
```{r}
vars = c(
        total = "B15003_001",       # total population 25+
        hsdiploma = "B15003_017",
        GED = "B15003_018",
        somecol_1yrminus = "B15003_019",
        somecol_1yrplus = "B15003_020",
        associates = "B15003_021",
        bachelors = "B15003_022",   # Bachelor's
        grad = "B15003_023",        # Master's
        professional = "B15003_024",# Professional school
        doctorate = "B15003_025"    # Doctorate
      )

education_data <- census_api_call(vars)

# test = census_api_call(vars, year = 2024, survey = "acs1")
# test <- test |> filter(nchar(fips) == 7)
# total_test = test |> filter(variable == "total")
#one of the billed benefits of PUMAs is availability of 1-year estimates but I see some missing data for 1-year estimates here
```

```{r}
# map_variables = "doctorate"
# 
# title = "Portion of Adults (25+) with a PhD"
# breaks_puma = c(0.8, 1.6, 3.2)
# breaks_state = c(1.25, 1.5, 1.75, 2)

# map_variables = "professional"
# 
# title = "Portion of Adults (25+) with a Professional Degree"
# breaks_puma = c(1.1, 2.2, 4.4)
# breaks_state = c(1.75, 2, 2.25, 2.5)

# map_variables = c("professional", "doctorate")
# 
# title = "Portion of Adults (25+) with a Doctorate or Professional Degree"
# breaks_puma = c(2, 4, 8)
# breaks_state = c(3, 3.5, 4, 4.5)

# map_variables = c("professional", "doctorate", "bachelors", "grad")
# 
# title = "Portion of Adults (25+) with a Bachelor's Degree or Higher"
# breaks_puma = c(20, 25, 35, 40, 45)
# breaks_state = c(30, 35, 40)

map_variables = c("hsdiploma", "GED", "somecol_1yrminus", "somecol_1yrplus", "associates", "professional", "doctorate", "bachelors", "grad")

title = "Portion of Adults (25+) with a High School Diploma or Equivalent"
breaks_puma = c(80, 85, 90, 95)
breaks_state = c(88, 90, 92)
```

```{r}
colors = list(high_color = "darkgreen")

filtered_education_data = filter_data(education_data, map_variables)

national_portion = filtered_education_data |>
  filter(fips == "1") |>
  pull(portion) * 100

education_subtitle = paste0("US: ", shorten_func()(national_portion), "%")

map(
  data = filtered_education_data |>
    filter(nchar(fips) == 2) |>
    rename(Value = portion),
  map = state_map,
  state_map = state_map,
  subtitle = education_subtitle,
  bubbles = F,
  unit = "%",
  title = title,
  source = "Census",
  caption_manual = caption_5year,
  breaks = breaks_state,
  inset_style = "split",
  palette = colors
)

map(
  data = filtered_education_data |>
    filter(nchar(fips) == 5) |>
    rename(Value = portion),
  map = county_map_planningregions,
  state_map = state_map_largepr,
  subtitle = education_subtitle,
  bubbles = F,
  unit = "%",
  title = title,
  source = "Census",
  caption_manual = caption_5year,
  breaks = breaks_puma,
  palette = colors
)

map(
  data = filtered_education_data |>
    filter(nchar(fips) == 7) |>
    rename(Value = portion),
  map = puma_map,
  state_map = state_map_largepr,
  subtitle = education_subtitle,
  bubbles = F,
  unit = "%",
  title = title,
  source = "Census",
  caption_manual = caption_5year,
  breaks = breaks_puma,
  palette = colors
)
```

#Percent Male
```{r}
vars <- c(
  total_pop   = "B01003_001",      # Total population
  male_15_17  = "B01001_007",
  male_18_19  = "B01001_008",
  male_20     = "B01001_009",
  male_21     = "B01001_010",
  male_22_24  = "B01001_011",
  male_25_29  = "B01001_012",
  male_30_34  = "B01001_013",
  male_35_39  = "B01001_014",
  male_40_44  = "B01001_015",
  male_45_49  = "B01001_016",
  male_50_54  = "B01001_017",
  male_55_59  = "B01001_018",
  male_60_61  = "B01001_019",
  male_62_64  = "B01001_020",
  
  female_15_17  = "B01001_031",
  female_18_19  = "B01001_032",
  female_20     = "B01001_033",
  female_21     = "B01001_034",
  female_22_24  = "B01001_035",
  female_25_29  = "B01001_036",
  female_30_34  = "B01001_037",
  female_35_39  = "B01001_038",
  female_40_44  = "B01001_039",
  female_45_49  = "B01001_040",
  female_50_54  = "B01001_041",
  female_55_59  = "B01001_042",
  female_60_61  = "B01001_043",
  female_62_64  = "B01001_044"
)
#this is a bit tedious, easier to make this one using IPUMS microdata

gender_data <- census_api_call(vars, geographies = c("us", "puma", "county", "state"))
```

```{r}
female_share <- function(df, lower = 18, upper = 64) {
  df %>%
    # Keep only variables with male/female labels
    filter(str_detect(variable, "^(male|female)_")) %>%
    # Extract sex and the lower bound of the age range from variable name
    mutate(
      sex = if_else(str_detect(variable, "^male"), "male", "female"),
      # pull out the age numbers from variable name, e.g. "male_18_19" → 18
      age_lower = as.numeric(str_extract(variable, "\\d+"))
    ) %>%
    # Restrict to chosen age range
    filter(age_lower >= lower, age_lower <= upper) %>%
    group_by(fips, NAME, sex) %>%
    summarise(pop = sum(estimate, na.rm = TRUE), .groups = "drop_last") %>%
    summarise(
      females = sum(pop[sex == "female"]),
      males   = sum(pop[sex == "male"]),
      total   = females + males,
      female_share = females / total,
      .groups = "drop"
    )
}

filtered_gender_data = female_share(gender_data)
```


```{r}
title = "Percent Female (18-64)"
breaks_puma = c(1, 3, 5)
breaks_state = c(0.2, 0.6, 1)
```


```{r}
colors = list(high_color = "red",
              low_color = "darkblue")

national_portion = filtered_gender_data |>
  filter(fips == "1") |>
  pull(female_share) * 100

gender_subtitle = paste0("US: ", shorten_func()(national_portion), "%")

map(
  data = filtered_gender_data |>
    filter(nchar(fips) == 5) |>
    rename(Value = female_share),
  map = county_map_planningregions,
  state_map = state_map_largepr,
  subtitle = gender_subtitle,
  bubbles = F,
  unit = "%",
  title = title,
  source = "Census",
  caption_manual = caption_5year,
  scale_center = 50,
  inset_style = "split",
  inset_cutoff = 50000,
  cutoff_column = "pop",
  breaks = breaks_puma,
  palette = colors
)

map(
  data = filtered_gender_data |>
    filter(nchar(fips) == 2) |>
    rename(Value = female_share),
  map = state_map,
  state_map = state_map,
  subtitle = gender_subtitle,
  bubbles = F,
  unit = "%",
  title = title,
  source = "Census",
  caption_manual = caption_5year,
  breaks = breaks_state,
  scale_center = 50,
  inset_style = "split",
  palette = colors
)

map(
  data = filtered_gender_data |>
    filter(nchar(fips) == 7) |>
    rename(Value = female_share),
  map = puma_map,
  state_map = state_map_largepr,
  subtitle = gender_subtitle,
  bubbles = F,
  unit = "%",
  title = title,
  source = "Census",
  scale_center = 50,
  inset_style = "split",
  city_insets = T,
  caption_manual = caption_5year,
  breaks = breaks_puma,
  palette = colors
)
```

# Housing year of construction
```{r}
vars = c(
        total      = "B25034_001", # total housing units
        post2020   = "B25034_002",
        y2010_19   = "B25034_003",
        y2000_09   = "B25034_004",
        y1990_99   = "B25034_005",
        y1980_89   = "B25034_006",
        y1970_79   = "B25034_007",
        y1960_69   = "B25034_008",
        y1950_59   = "B25034_009",
        y1940_49   = "B25034_010",
        pre1939    = "B25034_011"
      )

housing_data <- census_api_call(vars, year = year1, survey = "acs1")
# For post-2020 map
# census_results <- census_api_call(vars, year = 2024, survey = "acs1")
```

```{r}
# map_variables = c("pre1939", "y1940_49", "y1950_59")
# 
# title = "Portion of Housing Units Built Before 1960"
# breaks_puma = c(10, 20, 30, 40, 50)
# breaks_state = c(15, 25, 35, 45)
# 
# map_variables = c("pre1939")
# 
# title = "Portion of Housing Units Built Before 1940"
# breaks_puma = c(5, 15, 25, 35)
# breaks_state = c(5, 10, 15, 20)

map_variables = c("y2000_09", "y2010_19", "post2020")

title = "Portion of Housing Units Built Since 2000"
breaks_puma = c(20, 30, 40, 50)
breaks_state = c(25, 35, 45)

# Need to use 2024 1-year estimates for this one
# map_variables = c("post2020")
# 
# title = "Portion of Housing Units Built Since 2020 (2024)"
# breaks_puma = c(2, 6, 10, 14)
# breaks_state = c(2,4,6)
```

```{r}
colors = list(high_color = "darkblue")

filtered_housing_data = filter_data(housing_data, map_variables)

national_portion = filtered_housing_data |>
  filter(fips == "1") |>
  pull(portion)

housing_subtitle = paste0("US: ", shorten_func()(100*national_portion), "%")

# map(
#   data = filtered_housing_data |>
#     filter(nchar(fips) == 5) |>
#     rename(Value = portion,
#            units = total),
#   map = county_map_planningregions,
#   state_map = state_map_largepr,
#   subtitle = housing_subtitle,
#   bubbles = F,
#   unit = "%",
#   title = title,
#   source = "Census",
#   caption_manual = caption_1year,
#   breaks = breaks_puma,
#   inset_style = "split",
#   inset_cutoff = 10000,
#   cutoff_column = "units",
#   palette = colors
# )

map(
  data = filtered_housing_data |>
    filter(nchar(fips) == 7) |>
    rename(Value = portion,
           units = total),
  map = puma_map,
  state_map = state_map_largepr,
  subtitle = housing_subtitle,
  bubbles = F,
  unit = "%",
  title = title,
  source = "Census",
  city_insets = T,
  caption_manual = caption_1year,
  breaks = breaks_puma,
  palette = colors
)

map(
  data = filtered_housing_data |>
    filter(nchar(fips) == 2) |>
    rename(Value = portion,
           units = total),
  map = state_map,
  state_map = state_map,
  subtitle = housing_subtitle,
  bubbles = F,
  unit = "%",
  title = title,
  source = "Census",
  caption_manual = caption_1year,
  # breaks = breaks_state,
  inset_style = "split",
  palette = colors
)
```

#Median Year
```{r}
vars <- c(
  "total"        = "B25034_001",
  "1939_earlier" = "B25034_011",
  "1940_1949"    = "B25034_010",
  "1950_1959"    = "B25034_009",
  "1960_1969"    = "B25034_008",
  "1970_1979"    = "B25034_007",
  "1980_1989"    = "B25034_006",
  "1990_1999"    = "B25034_005",
  "2000_2009"    = "B25034_004",
  "2010_2019"    = "B25034_003",
  "2020_plus"    = "B25034_002"
)
# Bin ranges (inclusive start, inclusive end for simplicity)
bin_ranges <- list(
  `1939_earlier` = c(1900, 1939),  # 1900 is arbitrary but it will affect the calculations for a few cities
  `1940_1949`    = c(1940, 1949),
  `1950_1959`    = c(1950, 1959),
  `1960_1969`    = c(1960, 1969),
  `1970_1979`    = c(1970, 1979),
  `1980_1989`    = c(1980, 1989),
  `1990_1999`    = c(1990, 1999),
  `2000_2009`    = c(2000, 2009),
  `2010_2019`    = c(2010, 2019),
  `2020_plus`    = c(2020, 2023)   # this endpoint will not matter at all
)

housing_data_state <- get_acs(
  geography = "state",
  variables = vars,
  year = 2024,
  survey = "acs1"
)
median_build_state <- housing_data_state |>
  select(GEOID, NAME, variable, estimate) |>
  pivot_wider(names_from = variable, values_from = estimate)

housing_data_county <- get_acs(
  geography = "county",
  variables = vars,
  year = 2023,
  survey = "acs5"
)
median_build_county <- housing_data_county |>
  select(GEOID, NAME, variable, estimate) |>
  pivot_wider(names_from = variable, values_from = estimate)

# Function: weighted median with interpolation
estimate_median_year <- function(row) {
  counts <- as.numeric(row[names(bin_ranges)])
  total <- sum(counts)
  cutoff <- total / 2
  
  cum_counts <- cumsum(counts)
  bin_index <- which(cum_counts >= cutoff)[1]
  
  bin_name <- names(bin_ranges)[bin_index]
  bin_count <- counts[bin_index]
  bin_start <- bin_ranges[[bin_name]][1]
  bin_end   <- bin_ranges[[bin_name]][2]
  bin_width <- bin_end - bin_start + 1
  
  cum_before <- ifelse(bin_index > 1, cum_counts[bin_index - 1], 0)
  position_in_bin <- (cutoff - cum_before) / bin_count
  
  # interpolate uniformly within bin
  year_estimate <- bin_start + position_in_bin * bin_width
  return(year_estimate)
}


median_build_state$median_year_built <- apply(median_build_state, 1, estimate_median_year)
median_build_state$median_age <- year1 - median_build_state$median_year_built

median_build_county$median_year_built <- apply(median_build_county, 1, estimate_median_year)
median_build_county$median_age <- (year5 - 2) - median_build_county$median_year_built
```

```{r}
state_data <- median_build_state |>
  select(fips = GEOID, median_year_built, median_age)
county_data <- median_build_county |>
  select(fips = GEOID, median_year_built, median_age, total)

national_counts <- colSums(median_build_state[names(bin_ranges)])
national_row <- c(GEOID = "00000", NAME = "United States", as.list(national_counts))
national_median_year <- floor(estimate_median_year(national_row))
subtitle_myb = paste0("National Median Year Built: ", national_median_year)

title = "Median Age of Housing Units"

breaks_puma = c(25, 35, 45, 55, 65)
breaks_state = c(35, 45, 55)

colors = list(high_color = "darkblue")

map(
  data = county_data |>
    rename(Value = median_age,
           units = total),
  map = county_map_planningregions,
  state_map = NULL,
  subtitle = subtitle_myb,
  bubbles = F,
  unit = "years",
  title = title,
  source = "Census",
  caption_manual = caption_5year,
  breaks = breaks_puma,
  inset_style = "split",
  inset_cutoff = 10000,
  cutoff_column = "units",
  palette = colors
)

map(
  data = state_data |>
    rename(Value = median_age),
  map = state_map,
  state_map = state_map,
  subtitle = subtitle_myb,
  bubbles = F,
  unit = "years",
  title = title,
  source = "Census",
  caption_manual = "Source: 2024 ACS 1-year estimate",
  breaks = breaks_state,
  inset_style = "split",
  palette = colors
)

title = "Median Decade of Construction for Housing Units"

breaks_puma = c(1960, 1970, 1980, 1990, 2000)
breaks_state = c(1960, 1970, 1980, 1990)

map(
  data = county_data |>
    mutate(Value = round(median_year_built)),
  map = county_map_planningregions,
  state_map = state_map_largepr,
  subtitle = subtitle_myb,
  bubbles = F,
  numeric_type = "year",
  title = title,
  source = "Census",
  caption_manual = caption_5year,
  # breaks = breaks_puma,
  # inset_style = "hidden",
  # labels_manual = c("Before 1960", "1960s", "1970s", "1980s", "1990s", "2000s"),
  palette = colors
)

map(
  data = state_data |>
    mutate(Value = round(median_year_built)),
  map = state_map,
  state_map = state_map,
  subtitle = subtitle_myb,
  bubbles = F,
  numeric_type = "year",
  title = title,
  source = "Census",
  caption_manual = caption_1year,
  breaks = breaks_state,
  inset_style = "hidden",
  # labels_manual = c("Before 1960", "1960s", "1970s", "1980s", "1990s"),
  palette = colors
)

#Divergent color palette
map(
  data = county_data |>
    rename(Value = median_year_built),
  map = county_map_planningregions,
  state_map = state_map_largepr,
  subtitle = subtitle_myb,
  bubbles = F,
  unit = "years",
  title = title,
  source = "Census",
  caption_manual = caption_5year,
  breaks = c(0, 10, 20),
  scale_center = 1980,
  inset_style = "hidden",
  labels_manual = c("Before 1960", "1960s", "1970s", "1980s", "1990s", "2000s"),
  palette = list(low_color = "darkblue", high_color = "red")
)
```

# Employment by Sector/Occupation
```{r}
variable_names <- load_variables(year5, "acs5", cache = TRUE)

get_employment_data <- function(type = c("occupations", "industry"), 
                                level = c("state", "county", "puma", "us")) {
  type <- match.arg(type)
  
  # Helper function for a single geography
  get_single <- function(level) {
    if(type == "occupations") {
      vars <- variable_names |>
        filter(str_starts(name, "C24010")) |>
        select(name, label)
      col_names <- c("Total", "Gender", "Sector", "Occupation_Broad", "Occupation_Narrow")
    } else {
      vars <- variable_names |>
        filter(str_starts(name, "C24030")) |>
        select(name, label)
      col_names <- c("Total", "Gender", "Sector", "Occupation")
    }
    
    data <- get_acs(
      geography = level,
      table = ifelse(type == "occupations", "C24010", "C24030"),
      year = year5,
      survey = "acs5"
    ) |> 
      left_join(vars, by = c("variable" = "name")) |>
      mutate(label = str_remove(label, "Estimate!!"),
             label = str_remove(label, ":$")) |>
      separate(label, into = col_names, sep = ":!!", fill = "right", extra = "merge") |>
      rename(fips = GEOID) |>
      mutate(across(all_of(col_names), ~replace_na(., "total"))) |>
      group_by(fips, across(all_of(setdiff(col_names, c("Total", "Gender"))))) |>
      summarise(estimate = sum(estimate, na.rm = TRUE), .groups = "drop")
    
    totals <- data |> 
      filter(Sector == "total") |> 
      select(fips, total = estimate)
    
    data <- data |> 
      filter(Sector != "total") |> 
      left_join(totals, by = "fips") |>
      mutate(geography = level)  # keep track of geography
    
    return(data)
  }
  
  # Loop over all requested geographies and bind together
  result <- purrr::map_dfr(level, get_single)
  
  return(result)
}

occupation_data = get_employment_data("occupations")
industry_data = get_employment_data("industry")
```

# Industry data
```{r}
# sector = "Manufacturing"
# occupation = "total"
# title = "Portion of Civilian Employment in Manufacturing"
# breaks_puma = c(2.5, 5, 10)
# breaks_state = c(3, 5, 7)

sector = "Agriculture, forestry, fishing and hunting, and mining"
occupation = "Mining, quarrying, and oil and gas extraction"
title = "Portion of Civilian Employment in Mining and Oil and Gas Extraction"
breaks_puma = c(0.5, 1, 2, 5)
breaks_state = c(0.1, 0.2, 0.5, 1)

# sector = "Finance and insurance, and real estate, and rental and leasing"
# occupation = "Finance and insurance"
# title = "Portion of Civilian Employment in Finance and Insurance"
# breaks_puma = c(1, 2, 3, 4)
# breaks_puma = c(1.5, 2.5, 3.5, 4.5)
# breaks_state = c(2, 2.5, 3)
```

```{r}
colors = list(high_color = "darkgreen")
job_subtitle = paste0("US: ", round(
  industry_data |>
    filter(Sector == sector,
           Occupation == occupation,
           fips == "1") |>
    summarize(portion = estimate/total) |>
    pull(portion) * 100, 2), "%")



map(
  data = industry_data |>
    filter(Sector == sector,
           Occupation == occupation,
           nchar(fips) == 5) |>
    mutate(portion = estimate / total) |>
    rename(Value = portion),
  map = county_map_planningregions,
  state_map = state_map_largepr,
  subtitle = job_subtitle,
  bubbles = F,
  unit = "%",
  title = title,
  source = "Census",
  caption_manual = caption_5year,
  breaks = breaks_puma,
  # inset_style = "split",
  inset_cutoff = 10000,
  cutoff_column = "pop",
  palette = colors
)

map(
  data = industry_data |>
    filter(Sector == sector,
           Occupation == occupation,
           nchar(fips) == 2) |>
    mutate(portion = estimate / total) |>
    rename(Value = portion),
  map = state_map,
  state_map = state_map,
  subtitle = job_subtitle,
  bubbles = F,
  unit = "%",
  title = title,
  source = "Census",
  caption_manual = caption_5year,
  # breaks = breaks_state,
  inset_style = "split",
  palette = colors
)

map(
  data = industry_data |>
    filter(Sector == sector,
           Occupation == occupation,
           nchar(fips) == 7) |>
    mutate(portion = estimate / total) |>
    rename(Value = portion),
  map = puma_map,
  state_map = state_map_largepr,
  subtitle = job_subtitle,
  bubbles = F,
  unit = "%",
  title = title,
  source = "Census",
  caption_manual = caption_5year,
  breaks = breaks_puma,
  palette = colors
)
```

#Occupation map
```{r}
# sector = "Management, business, science, and arts occupations"
# occupation_broad = "Computer, engineering, and science occupations"
# occupation_narrow = "total"
# 
# title = "Portion of Civilian Employment in Computer, Engineering, and Science occupations"
# breaks_puma = c(1.5, 3, 6)
# breaks_state = c(3, 4, 5)
# 
# 
# sector = "Service occupations"
# occupation_broad = "Protective service occupations"
# occupation_narrow = "Firefighting and prevention, and other protective service workers including supervisors"
# 
# title = "Portion of Civilian Employment in Firefighting and Prevention"
# breaks_puma = c(0.2, 0.5, 1)
# breaks_state = c(0.4, 0.5, 0.6, 0.7, 0.8)
# 
# 
# sector = "Management, business, science, and arts occupations"
# occupation_broad = "Management, business, and financial occupations"
# occupation_narrow = "Business and financial operations occupations"
# 
# title = "Portion of Civilian Employment in Business and Financial Operations"
# breaks_puma = c(2, 3, 4, 5)
# breaks_state = c(2.25, 2.75, 3.25)


sector = "Natural resources, construction, and maintenance occupations"
occupation_broad = "Farming, fishing, and forestry occupations"
occupation_narrow = "total"

title = "Portion of Civilian Employment in Farming, Fishing, and Forestry"
breaks_puma = c(0.3, 0.6, 1.2, 2.4)
breaks_state = c(0.3, 0.5,0.7)


# sector = "Management, business, science, and arts occupations"
# occupation_broad = "Education, legal, community service, arts, and media occupations"
# occupation_narrow = "Educational instruction, and library occupations"
# 
# title = "Portion of Civilian Employment in Educational Instruction and Libraries"
# breaks_puma = c(2.5, 3.5, 4.5)
# breaks_state = c(2.75, 3, 3.25, 3.5, 3.75)
```

```{r}
colors = list(high_color = "darkgreen")
job_subtitle = paste0("US: ", round(
  occupation_data |>
    filter(fips == "1",
           Sector == sector,
           Occupation_Broad == occupation_broad,
           Occupation_Narrow == occupation_narrow) |>
    mutate(portion = estimate / total) |>
    pull(portion) * 100, 2), "%")



map(
  data = occupation_data |>
    filter(nchar(fips) == 5,
           Sector == sector,
           Occupation_Broad == occupation_broad,
           Occupation_Narrow == occupation_narrow) |>
    mutate(portion = estimate / total) |>
    rename(Value = portion),
  map = county_map_planningregions,
  state_map = state_map_largepr,
  subtitle = job_subtitle,
  bubbles = F,
  unit = "%",
  title = title,
  source = "Census",
  caption_manual = caption_5year,
  breaks = breaks_puma,
  inset_cutoff = 10000,
  cutoff_column = "pop",
  palette = colors
)

map(
  data = occupation_data |>
    filter(nchar(fips) == 2,
           Sector == sector,
           Occupation_Broad == occupation_broad,
           Occupation_Narrow == occupation_narrow) |>
    mutate(portion = estimate / total) |>
    rename(Value = portion),
  map = state_map,
  state_map = state_map,
  subtitle = job_subtitle,
  bubbles = F,
  unit = "%",
  title = title,
  source = "Census",
  caption_manual = caption_5year,
  # breaks = breaks_state,
  inset_style = "split",
  palette = colors
)

map(
  data = occupation_data |>
    filter(nchar(fips) == 7,
           Sector == sector,
           Occupation_Broad == occupation_broad,
           Occupation_Narrow == occupation_narrow) |>
    mutate(portion = estimate / total) |>
    rename(Value = portion),
  map = puma_map,
  state_map = state_map_largepr,
  subtitle = job_subtitle,
  bubbles = F,
  unit = "%",
  title = title,
  source = "Census",
  caption_manual = caption_5year,
  breaks = breaks_puma,
  palette = colors
)
```

# Ratio of Median Rent to Median Renter Income
Probably not as good of a map as using Census Bureau pre-computed rent burden
```{r}
# vars <- c(
#   "medgrossrent" = "B25064_001", #inflation adjusted by default (2023 dollars)
#   "medhhincome" = "B25119_003" #this is just for renter households (inflation adjusted)
# )
# 
# rent_data <- census_api_call(vars, year = year5)
# 
# rent_data <- rent_data |>
#   select(-moe) |>
#   pivot_wider(names_from = variable, values_from = estimate) |>
#   mutate(rent_to_income = medgrossrent * 12 / medhhincome)
# 
# rent_hhi_subtitle = paste0("US: ", round(
#   rent_data |>
#   filter(fips == 1) |>
#   pull(rent_to_income) * 100, 2), "%")
# 
# map(data = rent_data |> filter(nchar(fips) == 5) |>
#       rename(Value = rent_to_income),
#     map = county_map_planningregions,
#     state_map = state_map_largepr,
#     subtitle = rent_hhi_subtitle,
#     bubbles = F,
#     unit = "%",
#     title = "Ratio of Median Rent to Median Renter Income",
#     source = "Census",
#     caption_manual = caption,
#     scale_center = 31.5,
#     breaks = c(1.5, 4.5, 7.5),
#     inset_style = "split",
#     inset_cutoff = 200000,
#     cutoff_column = "pop",
#     palette = list(mid_color = "#ffda9a",
#                    na_color = "white")
# )
# 
# map(data = rent_data |> filter(nchar(fips) == 2) |>
#       rename(Value = rent_to_income),
#     map = state_map,
#     state_map = state_map,
#     subtitle = rent_hhi_subtitle,
#     bubbles = F,
#     unit = "%",
#     title = "Ratio of Median Rent to Median Renter Income",
#     source = "Census",
#     caption_manual = caption,
#     scale_center = 31,
#     breaks = c(1, 3),
#     inset_style = "split",
#     palette = list(mid_color = "#ffda9a")
# )

```

#Rent Burden
```{r}
# Define variables for rent burden table B25070
vars <- c(
  total = "B25070_001",                # Total renter households
  rent_lt_15 = "B25070_002",           # <15%
  rent_15_19 = "B25070_003",           # 15–19.9%
  rent_20_24 = "B25070_004",           # 20–24.9%
  rent_25_29 = "B25070_005",           # 25–29.9%
  rent_30_34 = "B25070_006",           # 30–34.9%
  rent_35_39 = "B25070_007",           # 35–39.9%
  rent_40_49 = "B25070_008",           # 40–49.9%
  rent_50_plus = "B25070_009",         # 50% or more
  rent_not_computed = "B25070_010"     # Not computed
)

rent_burden <- census_api_call(vars = vars)


rent_burden_summary <- rent_burden %>%
  group_by(fips, NAME) %>%
  summarise(
    total = sum(estimate[variable == "total"]) - sum(estimate[variable == "rent_not_computed"]),
    cost_burdened = sum(estimate[variable %in% c("rent_30_34", "rent_35_39", "rent_40_49", "rent_50_plus")]) / total,
    severely_burdened = sum(estimate[variable %in% c("rent_50_plus")]) / total,
    .groups = "drop"
  )
```

```{r}
rent_burdened_subtitle = paste0("US: ", round(
  rent_burden_summary |>
  filter(fips == 1) |>
  pull(cost_burdened) * 100, 2), "%")

map(data = rent_burden_summary |> filter(nchar(fips) == 5) |>
      rename(Value = cost_burdened),
    map = county_map_planningregions,
    state_map = state_map_largepr,
    subtitle = rent_burdened_subtitle,
    bubbles = F,
    unit = "%",
    title = "Portion of Renters that are Rent Burdened (>30% of Income)",
    source = "Census",
    caption_manual = caption_5year,
    scale_center = 43.5,
    breaks = c(1.5, 4.5, 7.5),
    inset_style = "split",
    inset_cutoff = 200000,
    cutoff_column = "pop"
    # palette = list(mid_color = "#ffda9a")
)

map(data = rent_burden_summary |> filter(nchar(fips) == 7) |>
      rename(Value = cost_burdened),
    map = puma_map,
    state_map = state_map_largepr,
    subtitle = rent_burdened_subtitle,
    bubbles = F,
    unit = "%",
    title = "Portion of Renters that are Rent Burdened (>30% of Income)",
    source = "Census",
    caption_manual = caption_5year,
    city_insets = T,
    scale_center = 43.5,
    breaks = c(1.5, 4.5, 7.5),
    inset_style = "split"
)

map(data = rent_burden_summary |> filter(nchar(fips) == 2) |>
      rename(Value = cost_burdened),
    map = state_map,
    state_map = state_map,
    subtitle = rent_burdened_subtitle,
    bubbles = F,
    unit = "%",
    title = "Portion of Renters that are Rent Burdened (>30% of Income)",
    source = "Census",
    caption_manual = caption_5year,
    scale_center = 43.5,
    breaks = c(1.5, 4.5),
    inset_style = "split"
    # palette = list(mid_color = "#ffda9a")
)

severely_burdened_subtitle = paste0("US: ", round(
  rent_burden_summary |>
  filter(fips == 1) |>
  pull(severely_burdened) * 100, 2), "%")

map(data = rent_burden_summary |> filter(nchar(fips) == 5) |>
      rename(Value = severely_burdened),
    map = county_map_planningregions,
    state_map = state_map_largepr,
    subtitle = severely_burdened_subtitle,
    bubbles = F,
    unit = "%",
    title = "Portion of Renters that are Severely Burdened (>50% of Income)",
    source = "Census",
    caption_manual = caption_5year,
    scale_center = 10.5,
    breaks = c(1, 3, 5),
    inset_style = "split",
    inset_cutoff = 200000,
    cutoff_column = "pop"
    # palette = list(mid_color = "#ffda9a",
    #                na_color = "white")
)

map(data = rent_burden_summary |> filter(nchar(fips) == 7) |>
      rename(Value = severely_burdened),
    map = puma_map,
    state_map = state_map_largepr,
    subtitle = severely_burdened_subtitle,
    bubbles = F,
    unit = "%",
    title = "Portion of Renters that are Severely Burdened (>50% of Income)",
    source = "Census",
    caption_manual = caption_5year,
    scale_center = 10.5,
    breaks = c(1, 3, 5),
    inset_style = "split"
)

map(data = rent_burden_summary |> filter(nchar(fips) == 2) |>
      rename(Value = severely_burdened),
    map = state_map,
    state_map = state_map,
    subtitle = severely_burdened_subtitle,
    bubbles = F,
    unit = "%",
    title = "Portion of Renters that are Severely Burdened (>50% of Income)",
    source = "Census",
    caption_manual = caption_5year,
    scale_center = 10.5,
    breaks = c(0.5, 1.5),
    inset_style = "split"
    # palette = list(mid_color = "#ffda9a")
)
```

#health insurance
IPUMS is better for these maps too
```{r}
vars <- c(
total = "B27020_001", # Total:
# Native:
# With health insurance coverage
# With private health insurance
native_public = "B27020_005",# With public coverage
native_uninsured = "B27020_006", # No health insurance coverage
# Foreign-born:
# Naturalized:
# With health insurance coverage
# With private health insurance
nat_public = "B27020_011", # With public coverage
nat_uninsured = "B27020_012", # No health insurance coverage
# Noncitizen:
# With health insurance coverage
# With private health insurance
non_public = "B27020_016", # With public coverage
non_uninsured = "B27020_017"# No health insurance coverage
)

health_insurance_data <- census_api_call(vars, geographies = c("puma", "state", "county")) |>
  select(fips, variable, estimate) |>
  pivot_wider(
    names_from = variable,
    values_from = estimate
  ) |>
  mutate(
    uninsured = native_uninsured + nat_uninsured + non_uninsured,
    public = native_public + nat_public + non_public,
    pct_uninsured = uninsured / total,
    pct_public = public / total
  )

public_insurance_subtitle = paste0("US: ", round(health_insurance_data |>
  filter(fips == "1") |>
  summarize(portion = public / total) |>
  pull(portion)*100, 2), "%")

map(data = health_insurance_data |> filter(nchar(fips) == 2) |>
      rename(Value = pct_public),
    map = state_map,
    state_map = state_map,
    subtitle = public_insurance_subtitle,
    bubbles = F,
    unit = "%",
    title = "Percent of People with Public Health Insurance",
    source = "Census",
    caption_manual = caption_5year,
    breaks = c(31, 35, 39, 43),
    inset_style = "split",
    palette = list(high_color = "darkgreen")
)

map(data = health_insurance_data |> filter(nchar(fips) == 7) |>
      rename(Value = pct_public),
    map = puma_map,
    state_map = state_map_largepr,
    subtitle = public_insurance_subtitle,
    bubbles = F,
    unit = "%",
    title = "Percent of People with Public Health Insurance",
    source = "Census",
    caption_manual = caption_5year,
    breaks = c(25, 30, 35, 40, 45, 50),
    palette = list(high_color = "darkgreen"),
    city_insets = T
)

uninsured_subtitle = paste0("US: ", round(health_insurance_data |>
  filter(fips == "1") |>
  summarize(portion = uninsured / total) |>
  pull(portion)*100, 2), "%")

caption = paste0("Source: ", year5-4, "-", year5," ACS 5-year estimates")

map(data = health_insurance_data |> filter(nchar(fips) == 2) |>
      rename(Value = pct_uninsured),
    map = state_map,
    state_map = state_map,
    subtitle = uninsured_subtitle,
    bubbles = F,
    unit = "%",
    title = "Percent of People Without Health Insurance",
    source = "Census",
    caption_manual = caption_5year,
    inset_style = "split",
    breaks = c(5, 8, 11),
    palette = list(high_color = "maroon")
)

map(data = health_insurance_data |> filter(nchar(fips) == 5) |>
      rename(Value = pct_uninsured),
    map = county_map_planningregions,
    state_map = state_map_largepr,
    subtitle = uninsured_subtitle,
    bubbles = F,
    unit = "%",
    title = "Percent of People Without Health Insurance",
    source = "Census",
    caption_manual = caption_5year,
    breaks = c(5, 7.5, 10, 15),
    palette = list(high_color = "maroon")
)

map(data = health_insurance_data |> filter(nchar(fips) == 7) |>
      rename(Value = pct_uninsured),
    map = puma_map,
    state_map = state_map_largepr,
    subtitle = uninsured_subtitle,
    bubbles = F,
    unit = "%",
    title = "Percent of People Without Health Insurance",
    source = "Census",
    caption_manual = caption_5year,
    breaks = c(5, 7.5, 10, 15),
    city_insets = T,
    palette = list(high_color = "maroon")
)

medicaid = read_csv("Data/MedicaidExpansion.csv") |>
  rename(name = state)

medicaid_data = state_map |> st_drop_geometry() |>
  select(name, fips) |>
  left_join(medicaid)

map(data = medicaid_data |> rename(Value = implementation_year),
    map = state_map |> filter(abbr != "PR"),
    state_map = state_map |> filter(abbr != "PR"),
    bubbles = F,
    title = "Year of Medicaid Expansion",
    source = "Other",
    caption_manual = "Source: KFF\nYears represent the year of implementation rather than passage of legislation",
    numeric_type = "year",
    inset_style = "hidden",
    na_label = "No Medicaid Expansion",
    breaks = c(2014.5, 2019.5),
    labels_manual = c("2014", "2015 to 2019", "2020 or later"),
    palette = list(mid_color = "darkblue",
      high_color = "#FFE5B4",
      na_color = "orange")
)

```

```{r}
vars = (median_age = "B01002_001")

median_age = census_api_call(vars, geographies = c("us", "puma", "state"), survey = "acs1")

us_median_age = median_age |>
  filter(fips == "1") |>
  pull(estimate)

#maybe add national value functionality to map... but not sure where to put it if not the subtitle
median_age_subtitle = paste0("US: ", round(us_median_age, 1))

caption = paste0("Source: 2023 American Community Survey")

#PUMA

map(data = median_age |> filter(nchar(fips) == 7) |>
      rename(Value = estimate),
    map = puma_map,
    state_map = state_map_largepr,
    subtitle = median_age_subtitle,
    bubbles = F,
    title = "Median Age",
    source = "Census",
    caption_manual = caption_5year,
    inset_style = "split",
    # city_insets = T,
    increment = 0.1,
    breaks = c(32, 36, 40, 44, 48),
    palette = list(high_color = "darkblue")
)

#STATE
map(data = median_age |> filter(nchar(fips) == 2) |>
      rename(Value = estimate),
    map = state_map,
    state_map = state_map,
    subtitle = median_age_subtitle,
    bubbles = F,
    title = "Median Age",
    source = "Census",
    caption_manual = caption_5year,
    inset_style = "split",
    increment = 0.1,
    breaks = c(37, 39, 41, 43),
    palette = list(high_color = "darkblue")
)

```

